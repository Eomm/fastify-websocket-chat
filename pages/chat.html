<!DOCTYPE html>
<html>

<head>
  <title>Fastify WebSockets chat</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, width=device-width" />
  <script src="https://unpkg.com/react@latest/umd/react.development.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@latest/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@mui/material@latest/umd/material-ui.development.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/babel-standalone@latest/babel.min.js" crossorigin="anonymous"></script>
  <!-- Fonts to support Material Design -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
  <!-- Icons to support Material Design -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">
    /**
     * PLEASE DON'T BLAME ME FOR THIS ONE SINGLE HUGE FILE.
     * The target of this file is for the purpose of learning WebSocket.
     * It's not meant to be a production-ready solution.
     * It's just a proof of concept.
     * 
     * Thank you for your understanding.
     */

    const {
      colors,
      CssBaseline,
      ThemeProvider,
      Typography,
      TextField,
      TextareaAutosize,
      Button,
      Grid,
      Container,
      createTheme,
      Box,
      SvgIcon,
      Link,
    } = MaterialUI;

    // Create a theme instance.
    const theme = createTheme({
      palette: {
        primary: { main: '#556cd6', },
        secondary: { main: '#19857b', },
        error: { main: colors.red.A400, },
      },
    });




    function App() {
      const [connecting, setConnecting] = React.useState(true);
      const [status, setStatus] = React.useState('');
      const [messages, setMessages] = React.useState([]);

      const [ws, setWs] = React.useState({});

      window.WebSocket = window.WebSocket || window.MozWebSocket;
      const connection = new WebSocket('ws://127.0.0.1:8080/chat');

      connection.onopen = function () {
        setConnecting(false);
        setStatus('Connected');
      };

      connection.onclose = function () {
        setConnecting(true);
        setStatus('Disconnected');
      };

      connection.onmessage = function (message) {
        try {
          const json = JSON.parse(message.data);
          switch (json.type) {
            case 'accepted':
            case 'message':
              setMessages(messages => [...messages, json.data]);
              break;
          }
        } catch (e) {
          console.error('Invalid JSON: ', message.data);
        }
      };

      connection.onerror = function (error) {
        setConnecting(true);
        setStatus(error.message);

        connection.close();
      };

      const submitMessage = (event) => {
        event.preventDefault();
        const data = new FormData(event.currentTarget);
        const message = data.get('chat-message');
        if (message && connecting === false) {
          connection.send(JSON.stringify({
            type: 'message',
            data: message,
          }));
        }
      };

      return (
        <Container component="main" maxWidth="xs">
          <CssBaseline />
          <Box
            sx={{
              marginTop: 8,
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
            }}
          >
            <Typography component="h1" variant="h5">
              Fastify WebSockets React Chat
            </Typography>
            <Box component="form" onSubmit={submitMessage} noValidate sx={{ mt: 1 }}>
              <TextareaAutosize
                maxRows={12}
                style={{ width: theme.spacing(60), height: theme.spacing(20) }}
                aria-label="maximum height"
                placeholder="Chat message"
                value={messages.join('\n')}
              />
              <TextField
                margin="normal"
                required
                fullWidth
                name="chat-message"
                label="Chat message"
                type="chat-message"
                id="chat-message"
                autoComplete="current-chat-message"
              />
              <Button
                type="submit"
                fullWidth
                disabled={connecting}
                variant="contained"
                sx={{ mt: 3, mb: 2 }}
              >
                {connecting ? 'Connecting...' : 'Send'}
              </Button>
              <Grid container alignItems="center" justifyContent="center">
                <Grid item>
                  {status}
                </Grid>
              </Grid>
            </Box>
          </Box>
        </Container>
      );
    }

    ReactDOM.render(
      <ThemeProvider theme={theme}>
        <App />
      </ThemeProvider>,
      document.querySelector('#root'),
    );
  </script>
</body>

</html>